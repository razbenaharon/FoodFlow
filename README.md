# FoodFlow â€“ Developer Guide & Runbook

FoodFlow simulates day-to-day operations for a restaurant (**HaSalon, Tel Aviv**), deciding **what to cook, sell, or donate** from inventory and expiring items. It is built from modular â€œagentsâ€.

---

## Repository Map (with explanations)

```
.
â”œâ”€ main.py                          # Entry point; orchestrates the full pipeline
â”œâ”€ requirements.txt                 # Python dependencies
â”œâ”€ README.md                        # Project documentation
â”‚
â”œâ”€ data/                            # Input data and generated state
â”‚  â”œâ”€ full_inventory.json           # Baseline stock of all items
â”‚  â”œâ”€ current_inventory.json        # Current inventory after removing expiring items
â”‚  â”œâ”€ expiring_ingredients.json     # Items selected as expiring in this run
â”‚  â”œâ”€ recent_expiring_ingredients.json              # Rolling history of expiring items
â”‚  â”œâ”€ recent_expiring_ingredients_backup_*.json     # Backups created when feedback agent runs
â”‚
â”œâ”€ results/                         # Outputs generated by agents
â”‚  â”œâ”€ messages/                     # Outgoing messages (kitchen, restaurant, soup kitchen)
â”‚  â”œâ”€ recipes/                      # Retrieved recipes from recipe agent
â”‚  â”‚  â””â”€ best_matching_recipes.json # Best recipe matches based on expiring ingredients
â”‚  â”œâ”€ best_soup_kitchen.json        # Selected soup kitchen for donation
â”‚  â”œâ”€ feedback_suggestions.json     # Procurement reduction suggestions (feedback agent)
â”‚  â”œâ”€ final_decision_output.json    # Final COOK / SELL / DONATE decisions per ingredient
â”‚  â””â”€ top_restaurants.json          # Ranked restaurants most likely to buy surplus
â”‚
â”œâ”€ examples/                        # Example run logs
â”‚  â”œâ”€ example1.txt â€¦ example6.txt
â”‚
â”œâ”€ tokens_count/                    # Token usage logs
â”‚  â”œâ”€ chat_tokens.txt
â”‚  â””â”€ embedding_tokens.txt
â”‚
â”œâ”€ agent/
â”‚  â”œâ”€ decision_agent/
â”‚  â”‚  â”œâ”€ final_decision_agent.py    # Consolidates inputs, prompts LLM, decides COOK/SELL/DONATE
â”‚  â”‚  â””â”€ prompts/
â”‚  â”‚     â””â”€ ingredient_decision_prompt.txt  # System prompt for decision agent
â”‚  â”‚
â”‚  â”œâ”€ execution_agent/
â”‚  â”‚  â”œâ”€ send_message.py            # Creates outbound messages for restaurant & soup kitchen
â”‚  â”‚  â””â”€ send_recipie_to_kitchen.py # Sends chosen recipe to kitchen (typo kept in filename)
â”‚  â”‚
â”‚  â”œâ”€ feedback_agent/
â”‚  â”‚  â”œâ”€ feedback_agent_prompt.txt  # Prompt for analyzing purchase patterns
â”‚  â”‚  â””â”€ get_feedback.py            # run_feedback_agent(): suggests procurement reductions
â”‚  â”‚
â”‚  â”œâ”€ recipe_agent/
â”‚  â”‚  â”œâ”€ __init__.py
â”‚  â”‚  â”œâ”€ recipe_agent.py              # Main recipe retrieval logic (builds queries & calls embeddings)
â”‚  â”‚  â”œâ”€ prompts/
â”‚  â”‚  â”‚  â””â”€ ingredient_classification_prompt.txt  # Classifies expiring items for query building
â”‚  â”‚  â”œâ”€ upload_recipies_to_qdrant/   # Loads recipe data into Qdrant
â”‚  â”‚  â”‚  â”œâ”€ __init__.py
â”‚  â”‚  â”‚  â””â”€ recipe_loader_to_qdrant.py  # Script to embed and upload recipes to vector DB
â”‚  â”‚  â””â”€ utilities/                   # Helper modules for recipe processing
â”‚  â”‚     â”œâ”€ __init__.py
â”‚  â”‚     â”œâ”€ classify.py               # Ingredient / recipe classification helpers
â”‚  â”‚     â”œâ”€ console.py                # Console output formatting utilities
â”‚  â”‚     â”œâ”€ io_utils.py               # Input/output helpers (JSON, CSV, etc.)
â”‚  â”‚     â”œâ”€ parsing.py                # Parsing functions for recipes & ingredients
â”‚  â”‚     â”œâ”€ recipe_query_builder.py   # Constructs embedding queries from ingredients
â”‚  â”‚     â”œâ”€ restaurant.py             # Shared models or helpers for restaurant/recipe linking
â”‚  â”‚     â””â”€ retrieval.py              # Qdrant retrieval utilities
â”‚  â”‚
â”‚  â”œâ”€ restaurant_agent/
â”‚  â”‚  â”œâ”€ find_restaurant.py         # Matches surplus items to nearby restaurants
â”‚  â”‚  â”œâ”€ nearby_restaurants.csv     # Restaurant dataset with distances & cuisines
â”‚  â”‚  â””â”€ restaurant_agent_prompt.txt # Prompt template for restaurant matching
â”‚  â”‚
â”‚  â””â”€ soup_kitchen_finder/
â”‚     â”œâ”€ find_soup_kitchen.py       # Selects best soup kitchen (closest / top 5 random)
â”‚     â”œâ”€ nearby_soup_kitchens.csv   # Dataset of soup kitchens with distance
â”‚     â””â”€ __init__.py
â”‚
â”œâ”€ utils/
â”‚  â”œâ”€ __init__.py
â”‚  â”œâ”€ chat_and_embedding.py          # Azure OpenAI chat + embeddings wrapper
â”‚  â”œâ”€ config.py                      # Centralized configuration
â”‚  â”œâ”€ fetch_soup_kitchens_tlv_with_distances.py  # Script to fetch soup kitchen dataset
â”‚  â”œâ”€ prepare_inventory.py           # Generates expiring & current inventory each run
â”‚  â””â”€ token_logger.py                # Logs tokens & estimates cost
â”‚
â”œâ”€ .env                              # Local environment vars (ignored by git)
â””â”€ config.py                         # Root-level config (mirrors utils/config.py)
```

---

## Pipeline Flow

1. **Prepare Inventory** â†’ `utils/prepare_inventory.py`  
   - Reads `full_inventory.json`  
   - Produces `current_inventory.json` and `expiring_ingredients.json`  
   - Updates `recent_expiring_ingredients.json`

2. **Soup Kitchen Finder** â†’ `agent/soup_kitchen_finder/find_soup_kitchen.py`  
   - Reads `nearby_soup_kitchens.csv`  
   - Selects top 5 closest, randomly picks one  
   - Saves to `results/best_soup_kitchen.json`

3. **Recipe Agent** â†’ `agent/recipe_agent/recipe_agent.py`  
   - Builds RAG query from expiring ingredients  
   - Retrieves recipes, saves to `results/recipes/best_matching_recipes.json`

4. **Restaurant Agent** â†’ `agent/restaurant_agent/find_restaurant.py`  
   - Matches surplus items with nearby restaurants  
   - Saves to `results/top_restaurants.json`

5. **Decision Agent** â†’ `agent/decision_agent/final_decision_agent.py`  
   - Loads expiring items, best recipes, top restaurants, soup kitchen  
   - Uses `ingredient_decision_prompt.txt`  
   - Produces 3-line COOK / SELL / DONATE output  
   - Saves to `results/final_decision_output.json`

6. **Execution Agents** â†’ `agent/execution_agent/`  
   - `send_recipie_to_kitchen.py`: prepares message to chef  
   - `send_message.py`: prepares messages to restaurant & soup kitchen  
   - Messages stored under `results/messages/`

7. **Feedback Agent** â†’ `agent/feedback_agent/get_feedback.py`  
   - Runs if â‰¥10 history runs exist in `recent_expiring_ingredients.json`  
   - Flattens history, applies `feedback_agent_prompt.txt`  
   - Produces **procurement reduction suggestions** in `feedback_suggestions.json`  
   - Backs up history and resets it

8. **Token Logging** â†’ `utils/token_logger.py`  
   - Records token counts under `tokens_count/`  
   - Prints cost banner at start of run

---

## Examples

The `examples/` folder contains logs (`example1.txt` â€¦ `example6.txt`) showing full runs:  
- inventory state  
- chosen soup kitchen  
- matched recipes & restaurants  
- decision agentâ€™s COOK / SELL / DONATE output  
- outbound messages  
- feedback agent activation (every 10 runs)

---

ğŸš€ Happy shipping with FoodFlow!
