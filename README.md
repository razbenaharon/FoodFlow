# FoodFlow – Developer Guide & Runbook

FoodFlow simulates day-to-day operations for a restaurant (**HaSalon, Tel Aviv**), deciding **what to cook, sell, or donate** from inventory and expiring items. It is built from modular “agents”.

---

## Repository Map (with explanations)

```
.
├─ main.py                          # Entry point; orchestrates the full pipeline
├─ requirements.txt                 # Python dependencies
├─ README.md                        # Project documentation
│
├─ data/                            # Input data and generated state
│  ├─ full_inventory.json           # Baseline stock of all items
│  ├─ current_inventory.json        # Current inventory after removing expiring items
│  ├─ expiring_ingredients.json     # Items selected as expiring in this run
│  ├─ recent_expiring_ingredients.json              # Rolling history of expiring items
│  ├─ recent_expiring_ingredients_backup_*.json     # Backups created when feedback agent runs
│
├─ results/                         # Outputs generated by agents
│  ├─ messages/                     # Outgoing messages (kitchen, restaurant, soup kitchen)
│  ├─ recipes/                      # Retrieved recipes from recipe agent
│  │  └─ best_matching_recipes.json # Best recipe matches based on expiring ingredients
│  ├─ best_soup_kitchen.json        # Selected soup kitchen for donation
│  ├─ feedback_suggestions.json     # Procurement reduction suggestions (feedback agent)
│  ├─ final_decision_output.json    # Final COOK / SELL / DONATE decisions per ingredient
│  └─ top_restaurants.json          # Ranked restaurants most likely to buy surplus
│
├─ examples/                        # Example run logs
│  ├─ example1.txt … example6.txt
│
├─ tokens_count/                    # Token usage logs
│  ├─ chat_tokens.txt
│  └─ embedding_tokens.txt
│
├─ agent/
│  ├─ decision_agent/
│  │  ├─ final_decision_agent.py    # Consolidates inputs, prompts LLM, decides COOK/SELL/DONATE
│  │  └─ prompts/
│  │     └─ ingredient_decision_prompt.txt  # System prompt for decision agent
│  │
│  ├─ execution_agent/
│  │  ├─ send_message.py            # Creates outbound messages for restaurant & soup kitchen
│  │  └─ send_recipie_to_kitchen.py # Sends chosen recipe to kitchen (typo kept in filename)
│  │
│  ├─ feedback_agent/
│  │  ├─ feedback_agent_prompt.txt  # Prompt for analyzing purchase patterns
│  │  └─ get_feedback.py            # run_feedback_agent(): suggests procurement reductions
│  │
│  ├─ recipe_agent/
│  │  ├─ __init__.py
│  │  ├─ recipe_agent.py              # Main recipe retrieval logic (builds queries & calls embeddings)
│  │  ├─ prompts/
│  │  │  └─ ingredient_classification_prompt.txt  # Classifies expiring items for query building
│  │  ├─ upload_recipies_to_qdrant/   # Loads recipe data into Qdrant
│  │  │  ├─ __init__.py
│  │  │  └─ recipe_loader_to_qdrant.py  # Script to embed and upload recipes to vector DB
│  │  └─ utilities/                   # Helper modules for recipe processing
│  │     ├─ __init__.py
│  │     ├─ classify.py               # Ingredient / recipe classification helpers
│  │     ├─ console.py                # Console output formatting utilities
│  │     ├─ io_utils.py               # Input/output helpers (JSON, CSV, etc.)
│  │     ├─ parsing.py                # Parsing functions for recipes & ingredients
│  │     ├─ recipe_query_builder.py   # Constructs embedding queries from ingredients
│  │     ├─ restaurant.py             # Shared models or helpers for restaurant/recipe linking
│  │     └─ retrieval.py              # Qdrant retrieval utilities
│  │
│  ├─ restaurant_agent/
│  │  ├─ find_restaurant.py         # Matches surplus items to nearby restaurants
│  │  ├─ nearby_restaurants.csv     # Restaurant dataset with distances & cuisines
│  │  └─ restaurant_agent_prompt.txt # Prompt template for restaurant matching
│  │
│  └─ soup_kitchen_finder/
│     ├─ find_soup_kitchen.py       # Selects best soup kitchen (closest / top 5 random)
│     ├─ nearby_soup_kitchens.csv   # Dataset of soup kitchens with distance
│     └─ __init__.py
│
├─ utils/
│  ├─ __init__.py
│  ├─ chat_and_embedding.py          # Azure OpenAI chat + embeddings wrapper
│  ├─ config.py                      # Centralized configuration
│  ├─ fetch_soup_kitchens_tlv_with_distances.py  # Script to fetch soup kitchen dataset
│  ├─ prepare_inventory.py           # Generates expiring & current inventory each run
│  └─ token_logger.py                # Logs tokens & estimates cost
│
├─ .env                              # Local environment vars (ignored by git)
└─ config.py                         # Root-level config (mirrors utils/config.py)
```

---

## Pipeline Flow

1. **Prepare Inventory** → `utils/prepare_inventory.py`  
   - Reads `full_inventory.json`  
   - Produces `current_inventory.json` and `expiring_ingredients.json`  
   - Updates `recent_expiring_ingredients.json`

2. **Soup Kitchen Finder** → `agent/soup_kitchen_finder/find_soup_kitchen.py`  
   - Reads `nearby_soup_kitchens.csv`  
   - Selects top 5 closest, randomly picks one  
   - Saves to `results/best_soup_kitchen.json`

3. **Recipe Agent** → `agent/recipe_agent/recipe_agent.py`  
   - Builds RAG query from expiring ingredients  
   - Retrieves recipes, saves to `results/recipes/best_matching_recipes.json`

4. **Restaurant Agent** → `agent/restaurant_agent/find_restaurant.py`  
   - Matches surplus items with nearby restaurants  
   - Saves to `results/top_restaurants.json`

5. **Decision Agent** → `agent/decision_agent/final_decision_agent.py`  
   - Loads expiring items, best recipes, top restaurants, soup kitchen  
   - Uses `ingredient_decision_prompt.txt`  
   - Produces 3-line COOK / SELL / DONATE output  
   - Saves to `results/final_decision_output.json`

6. **Execution Agents** → `agent/execution_agent/`  
   - `send_recipie_to_kitchen.py`: prepares message to chef  
   - `send_message.py`: prepares messages to restaurant & soup kitchen  
   - Messages stored under `results/messages/`

7. **Feedback Agent** → `agent/feedback_agent/get_feedback.py`  
   - Runs if ≥10 history runs exist in `recent_expiring_ingredients.json`  
   - Flattens history, applies `feedback_agent_prompt.txt`  
   - Produces **procurement reduction suggestions** in `feedback_suggestions.json`  
   - Backs up history and resets it

8. **Token Logging** → `utils/token_logger.py`  
   - Records token counts under `tokens_count/`  
   - Prints cost banner at start of run

---

## Examples

The `examples/` folder contains logs (`example1.txt` … `example6.txt`) showing full runs:  
- inventory state  
- chosen soup kitchen  
- matched recipes & restaurants  
- decision agent’s COOK / SELL / DONATE output  
- outbound messages  
- feedback agent activation (every 10 runs)

---

🚀 Happy shipping with FoodFlow!
